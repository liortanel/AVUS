@{
    ViewData["Title"] = "Calendario";
    int year = ViewBag.Year ?? DateTime.Now.Year;
    int month = ViewBag.Month ?? DateTime.Now.Month;
    var eventos = ViewBag.Eventos as List<Evento> ?? new List<Evento>();
    var eventosPorDia = eventos
        .GroupBy(e => e.fecha.Date)
        .ToDictionary(g => g.Key, g => g.ToList());

    var primerDiaMes = new DateTime(year, month, 1);
    int diaSemanaPrimer = (int)primerDiaMes.DayOfWeek; // 0=Sunday
    int offset = (diaSemanaPrimer + 6) % 7; // Convertir a 0=Lunes
    int diasMes = DateTime.DaysInMonth(year, month);
    var prev = primerDiaMes.AddMonths(-1);
    var next = primerDiaMes.AddMonths(1);
    var es = System.Globalization.CultureInfo.GetCultureInfo("es-ES");
    var tituloMes = es.TextInfo.ToTitleCase(primerDiaMes.ToString("MMMM yyyy", es));
}

<div class="calendar-container">
    <div class="tutoriales-header">
        <h1><i class="fas fa-calendar-alt" aria-hidden="true"></i> Calendario</h1>
        <p>Visualizá tus eventos del mes y gestioná tus días</p>
    </div>

    <section class="calendar-shell" aria-live="polite">
        <div class="calendar-toolbar" role="group" aria-label="Cambiar mes">
            <a class="btn btn-secondary btn-icon-only" href="/Home/Calendario?year=@prev.Year&month=@prev.Month" aria-label="Ver el mes anterior">
                <span aria-hidden="true">«</span>
            </a>
            <h2 class="calendar-title" id="calendarTitle">@tituloMes</h2>
            <a class="btn btn-secondary btn-icon-only" href="/Home/Calendario?year=@next.Year&month=@next.Month" aria-label="Ver el mes siguiente">
                <span aria-hidden="true">»</span>
            </a>
        </div>

        <div class="calendar-weekdays" role="row">
            <span class="calendar-weekday" role="columnheader">Lun</span>
            <span class="calendar-weekday" role="columnheader">Mar</span>
            <span class="calendar-weekday" role="columnheader">Mié</span>
            <span class="calendar-weekday" role="columnheader">Jue</span>
            <span class="calendar-weekday" role="columnheader">Vie</span>
            <span class="calendar-weekday" role="columnheader">Sáb</span>
            <span class="calendar-weekday" role="columnheader">Dom</span>
        </div>

        <div class="calendar-grid" role="grid" aria-labelledby="calendarTitle">
            @{
                int dia = 1;
                for (int fila = 0; fila < 6; fila++)
                {
                    for (int col = 0; col < 7; col++)
                    {
                        if (fila == 0 && col < offset || dia > diasMes)
                        {
                            <div class="calendar-day calendar-day--empty" aria-hidden="true"></div>
                        }
                        else
                        {
                            var fechaActual = new DateTime(year, month, dia);
                            bool tieneEventos = eventosPorDia.ContainsKey(fechaActual.Date);
                            var lista = tieneEventos ? eventosPorDia[fechaActual.Date] : new List<Evento>();
                            var primero = lista.FirstOrDefault();
                            var extra = Math.Max(lista.Count - 1, 0);
                            var esHoy = fechaActual.Date == DateTime.Today;
                            var descripcionEventos = tieneEventos
                                ? $"{lista.Count} evento{(lista.Count > 1 ? "s" : string.Empty)}: {string.Join(", ", lista.Select(e => e.nombre))}"
                                : "sin eventos programados";
                            var cellClasses = "calendar-day"
                                + (esHoy ? " calendar-day--today" : string.Empty)
                                + (tieneEventos ? " calendar-day--has-events" : string.Empty);

                            <div class="@cellClasses" role="gridcell" aria-label=$"Día {dia} de {tituloMes}: {descripcionEventos}">
                                <a href="/Home/EditarCalendario?fecha=@fechaActual.ToString("yyyy-MM-dd")"
                                   class="calendar-day-link"
                                   aria-label=$"Gestionar eventos del {fechaActual:dd 'de' MMMM}">
                                    <span class="calendar-day-number">@dia</span>
                                    <div class="calendar-day-events">
                                        @if (primero != null)
                                        {
                                            <span class="calendar-day-event">@primero.nombre</span>
                                        }
                                        @if (extra > 0)
                                        {
                                            <span class="calendar-day-more">+@extra más</span>
                                        }
                                    </div>
                                </a>
                            </div>
                            dia++;
                        }
                    }
                }
            }
        </div>
    </section>
</div>

